podTemplate(label: 'clairctl', 
	containers: [
		containerTemplate(name: 'golang', image: 'golang:1.8', ttyEnabled: true, command: '/bin/sh -c', args: 'cat'),
		containerTemplate(name: 'docker', image: 'ptcos/docker-client:latest', alwaysPullImage: true, ttyEnabled: true, command: '/bin/sh -c', args: 'cat')
	],
	volumes: [
		hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock')
	]
) {

	node('clairctl') {
		checkout scm

		container('golang') {
			sh """
			go-wrapper download github.com/jgsqware/clairctl
			CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o /go/bin/clairctl github.com/jgsqware/clairctl
			mv -f /go/bin/clairctl $WORKSPACE/clairctl
			"""
		}

		container('docker') {
			docker.withRegistry('https://registry.hub.docker.com','docker-hub-credentials') {
				sh """
				docker build -t ptcos/docker-client:latest -t ptcos/docker-client:1.1.$BUILD_NUMBER .
				"""
				
				def image = docker.image("ptcos/docker-client")
				image.push('latest')
				image.push('1.1.$BUILD_NUMBER')
		}
	}
}