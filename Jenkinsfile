library 'jenkins-ptcs-library@0.2.2'

podTemplate(label: pod.label,
    containers: pod.templates + [
        containerTemplate(name: 'golang', image: 'golang:1.8', ttyEnabled: true, command: '/bin/sh -c', args: 'cat'),
    ],
    volumes: [
        hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock')
    ]
) {
    node(pod.label) {
        stage('Checkout') {
            checkout scm
        }
        stage('Build') {
            container('golang') {
                sh """
                go-wrapper download github.com/jgsqware/clairctl
                cd /go/src/github.com/jgsqware/clairctl
                go get -u github.com/jteeuwen/go-bindata/...
                go generate ./clair
                cd /go
                CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o /go/bin/clairctl github.com/jgsqware/clairctl
                mv -f /go/bin/clairctl $WORKSPACE/clairctl
                """
            }
        }
        stage('Package') {
            env.TAG_NAME = "0.0.1-test"
            env.BRANCH_NAME = "0.0.1-test"
            publishTagToDockerhub("docker-client")
        }
    }
}
